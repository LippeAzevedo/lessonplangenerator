<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Plan Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* Lightest gray for body */
        }
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 600px;
            border-radius: 0.5rem;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .form-input, .form-textarea, .form-select {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm;
        }
        .form-label {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
        .btn {
            @apply px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2;
        }
        .btn-primary {
            @apply bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-500;
        }
        .btn-secondary {
            @apply bg-gray-600 hover:bg-gray-700 focus:ring-gray-500;
        }
        .btn-danger {
            @apply bg-red-600 hover:bg-red-700 focus:ring-red-500;
        }
        .btn-success {
            @apply bg-green-600 hover:bg-green-700 focus:ring-green-500;
        }
        .stage-card {
            @apply bg-white p-4 rounded-lg shadow mb-4 border border-gray-200;
        }
        .section-container {
            @apply bg-white p-6 rounded-lg shadow-lg mb-8 border border-gray-200;
        }
        .section-container-alt { 
            @apply bg-gray-50 p-6 rounded-lg shadow-lg mb-8 border border-gray-200;
        }
        .section-title {
             @apply text-xl font-semibold mb-4 text-indigo-700 border-b-2 border-indigo-200 pb-3;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-6 text-center">
            <img src="https://www.passaporteedu.com.br/images/logotipo_slogan.svg" alt="Passaporte Edu Logo" id="logoImage" class="mx-auto mb-4 h-16 sm:h-20" crossorigin="anonymous" onerror="this.alt='Passaporte Edu Logo could not be loaded'; this.style.display='none'; document.getElementById('logo-error-message').style.display='block';">
            <p id="logo-error-message" style="display:none;" class="text-red-500 text-sm">Logo could not be loaded from external URL.</p>
            <h1 class="text-2xl sm:text-3xl font-bold text-indigo-700">Lesson Plan Generator</h1>
        </header>

        <div id="message-area" class="mb-4"></div>

        <div class="section-container-alt">
            <h2 class="section-title">Lesson Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="teacher" class="form-label">Teacher:</label>
                    <input type="text" id="teacher" class="form-input">
                </div>
                <div>
                    <label for="classType" class="form-label">Class Type:</label>
                    <input type="text" id="classType" class="form-input">
                </div>
                <div class="md:col-span-2">
                    <label for="lessonAim" class="form-label">Lesson's Aim:</label>
                    <textarea id="lessonAim" rows="2" class="form-textarea"></textarea>
                </div>
                <div class="md:col-span-2">
                    <label for="objective" class="form-label">Objective:</label>
                    <textarea id="objective" rows="2" class="form-textarea"></textarea>
                </div>
                <div>
                    <label for="date" class="form-label">Date:</label>
                    <input type="date" id="date" class="form-input">
                </div>
                <div>
                    <label for="class" class="form-label">Class:</label>
                    <input type="text" id="class" class="form-input">
                </div>
                <div>
                    <label for="level" class="form-label">Level:</label>
                    <input type="text" id="level" class="form-input">
                </div>
                <div>
                    <label for="numStudents" class="form-label">Number of Students:</label>
                    <input type="number" id="numStudents" class="form-input" min="0">
                </div>
                <div class="md:col-span-2">
                    <label for="possibleProblems" class="form-label">Possible Problems:</label>
                    <textarea id="possibleProblems" rows="2" class="form-textarea"></textarea>
                </div>
            </div>
        </div>

        <div class="section-container">
            <div class="flex justify-between items-center mb-4 border-b-2 border-indigo-200 pb-3">
                <h2 class="text-xl font-semibold text-indigo-700">Lesson Stages</h2>
                <button id="openAddStageModal" class="btn btn-primary text-sm">+ Add Stage</button>
            </div>
            <div id="stages-container">
                </div>
        </div>

        <footer class="mt-8 flex flex-wrap justify-center gap-3 sm:gap-4">
            <button id="saveLessonPlan" class="btn btn-success">Save Plan</button>
            <button id="loadLessonPlan" class="btn btn-secondary">Load Plan</button>
            <button id="clearLessonPlan" class="btn btn-danger">Clear Plan</button>
            <button id="downloadPdf" class="btn btn-primary">Download as PDF</button>
        </footer>
        <p class="text-xs text-gray-500 mt-4 text-center">PDF generation might have limitations with complex styling or direct SVG embedding.</p>

    </div>

    <div id="addStageModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeAddStageModal">&times;</span>
            <h3 class="text-lg font-medium mb-4 text-indigo-600">Add New Stage</h3>
            <div>
                <label for="stageType" class="form-label">Stage Type:</label>
                <select id="stageType" class="form-select mb-2">
                    <option value="Warm Up!">Warm Up!</option>
                    <option value="Presentation">Presentation</option>
                    <option value="Practice">Practice</option>
                    <option value="Production">Production</option>
                    <option value="Break">Break</option>
                    <option value="Wrap Up!">Wrap Up!</option>
                    <option value="Homework">Homework</option>
                    <option value="Custom">Custom</option>
                </select>
            </div>
            <div>
                <label for="newStageName" class="form-label">Stage Name (if Custom):</label>
                <input type="text" id="newStageName" class="form-input mb-2" disabled>
            </div>
            <div>
                <label for="newStageAim" class="form-label">Aim:</label>
                <textarea id="newStageAim" rows="2" class="form-textarea mb-2"></textarea>
            </div>
            <div>
                <label for="newStageActivity" class="form-label">Activity/Procedure:</label>
                <textarea id="newStageActivity" rows="3" class="form-textarea mb-2"></textarea>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-2">
                <div>
                    <label for="newStageFocus" class="form-label">Focus (e.g., T-S, S-S):</label>
                    <input type="text" id="newStageFocus" class="form-input">
                </div>
                <div>
                    <label for="newStageMaterial" class="form-label">Material:</label>
                    <input type="text" id="newStageMaterial" class="form-input">
                </div>
                <div>
                    <label for="newStageTiming" class="form-label">Timing (min):</label>
                    <input type="number" id="newStageTiming" class="form-input" min="0">
                </div>
            </div>
            <div id="productionTimeWarning" class="text-red-500 text-sm mb-2" style="display: none;">Production stage should not exceed 20 minutes.</div>
            <button id="confirmAddStage" class="btn btn-primary w-full">Add Stage</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageArea = document.getElementById('message-area');

    function displayMessage(message, type = 'success') {
        if (!messageArea) {
            console.error("Message area not found!");
            return;
        }
        const messageDiv = document.createElement('div');
        messageDiv.textContent = message;
        messageDiv.className = `p-3 rounded-md mb-4 text-sm ${type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
        messageArea.innerHTML = ''; 
        messageArea.appendChild(messageDiv);
        setTimeout(() => {
            if (messageArea.contains(messageDiv)) {
                 messageArea.innerHTML = '';
            }
        }, 4000);
    }

    // Verifica se a biblioteca jsPDF foi carregada
    if (typeof jspdf === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
        console.error("jsPDF library is not loaded correctly!");
        displayMessage("Error: The PDF generation library (jsPDF) failed to load. Please check your internet connection or try refreshing the page.", 'error');
        const downloadBtn = document.getElementById('downloadPdf');
        if (downloadBtn) {
            downloadBtn.disabled = true;
            downloadBtn.title = "PDF generation is unavailable.";
            downloadBtn.classList.remove('btn-primary');
            downloadBtn.classList.add('btn-secondary', 'opacity-50', 'cursor-not-allowed');
        }
        return; 
    }
    
    // Verifica se o plugin jsPDF-AutoTable foi carregado
    const tempDocCheck = new jspdf.jsPDF();
    if (typeof tempDocCheck.autoTable !== 'function') {
        console.error("jsPDF-AutoTable plugin is not loaded correctly or not attached to jsPDF instances!");
        displayMessage("Error: The PDF table generation plugin (jsPDF-AutoTable) failed to load. Tables might not be generated correctly.", 'error');
    }


    const { jsPDF } = jspdf; 

    // Estado da aplicação
    const appState = {
        teacher: '',
        classType: '',
        lessonAim: '',
        objective: '',
        date: '',
        class: '',
        level: '',
        numStudents: '',
        possibleProblems: '',
        stages: []
    };

    // Elementos DOM
    const teacherInput = document.getElementById('teacher');
    const classTypeInput = document.getElementById('classType');
    const lessonAimInput = document.getElementById('lessonAim');
    const objectiveInput = document.getElementById('objective');
    const dateInput = document.getElementById('date');
    const classInput = document.getElementById('class');
    const levelInput = document.getElementById('level');
    const numStudentsInput = document.getElementById('numStudents');
    const possibleProblemsInput = document.getElementById('possibleProblems');
    const stagesContainer = document.getElementById('stages-container');

    // Elementos do Modal
    const addStageModal = document.getElementById('addStageModal');
    const openAddStageModalBtn = document.getElementById('openAddStageModal');
    const closeAddStageModalBtn = document.getElementById('closeAddStageModal');
    const stageTypeSelect = document.getElementById('stageType');
    const newStageNameInput = document.getElementById('newStageName');
    const newStageAimInput = document.getElementById('newStageAim');
    const newStageActivityInput = document.getElementById('newStageActivity');
    const newStageFocusInput = document.getElementById('newStageFocus');
    const newStageMaterialInput = document.getElementById('newStageMaterial');
    const newStageTimingInput = document.getElementById('newStageTiming');
    const confirmAddStageBtn = document.getElementById('confirmAddStage');
    const productionTimeWarning = document.getElementById('productionTimeWarning');
    
    // Salva o estado atual no localStorage
    function saveState() {
        appState.teacher = teacherInput.value;
        appState.classType = classTypeInput.value;
        appState.lessonAim = lessonAimInput.value;
        appState.objective = objectiveInput.value;
        appState.date = dateInput.value;
        appState.class = classInput.value;
        appState.level = levelInput.value;
        appState.numStudents = numStudentsInput.value;
        appState.possibleProblems = possibleProblemsInput.value;
        try {
            localStorage.setItem('lessonPlanData', JSON.stringify(appState));
            displayMessage('Lesson plan saved successfully!');
        } catch (e) {
            console.error("Error saving to localStorage:", e);
            displayMessage('Failed to save lesson plan. Local storage might be full or disabled.', 'error');
        }
    }

    // Carrega o estado do localStorage
    function loadState() {
        try {
            const savedData = localStorage.getItem('lessonPlanData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                Object.assign(appState, parsedData); 
                teacherInput.value = appState.teacher || '';
                classTypeInput.value = appState.classType || '';
                lessonAimInput.value = appState.lessonAim || '';
                objectiveInput.value = appState.objective || '';
                dateInput.value = appState.date || '';
                classInput.value = appState.class || '';
                levelInput.value = appState.level || '';
                numStudentsInput.value = appState.numStudents || '';
                possibleProblemsInput.value = appState.possibleProblems || '';
                appState.stages = Array.isArray(appState.stages) ? appState.stages : [];
                renderStages();
                displayMessage('Lesson plan loaded successfully!');
            } else {
                renderStages(); // Renderiza mesmo que não haja dados salvos (estado vazio)
            }
        } catch (e) {
            console.error("Error loading from localStorage:", e);
            displayMessage('Failed to load lesson plan. Saved data might be corrupted.', 'error');
            appState.stages = []; 
            renderStages();
        }
    }
    
    // Limpa o estado atual e o localStorage
    function clearState() {
        showConfirmationModal('Are you sure you want to clear the entire lesson plan? This cannot be undone.', () => {
            localStorage.removeItem('lessonPlanData');
            // Reseta o objeto appState
            appState.teacher = '';
            appState.classType = '';
            appState.lessonAim = '';
            appState.objective = '';
            appState.date = ''; // A data será resetada para o padrão depois
            appState.class = '';
            appState.level = '';
            appState.numStudents = '';
            appState.possibleProblems = '';
            appState.stages = [];
            // Limpa os campos do formulário
            teacherInput.value = '';
            classTypeInput.value = '';
            lessonAimInput.value = '';
            objectiveInput.value = '';
            classInput.value = '';
            levelInput.value = '';
            numStudentsInput.value = '';
            possibleProblemsInput.value = '';
            setDefaultDate(); // Define a data padrão novamente
            renderStages();
            displayMessage('Lesson plan cleared.');
        });
    }

    // Renderiza as etapas da aula na tela
    function renderStages() {
        stagesContainer.innerHTML = ''; 
        if (!appState.stages || appState.stages.length === 0) {
            stagesContainer.innerHTML = '<p class="text-gray-500">No stages added yet. Click "+ Add Stage" to begin.</p>';
            return;
        }
        appState.stages.forEach((stage) => {
            const stageDiv = document.createElement('div');
            stageDiv.className = 'stage-card';
            const stageName = stage.name || 'Unnamed Stage';
            const stageAim = stage.aim || '';
            const stageActivity = stage.activity || '';
            const stageFocus = stage.focus || '';
            const stageMaterial = stage.material || '';
            const stageTiming = stage.timing || '0';
            const stageId = stage.id || crypto.randomUUID(); // Garante um ID
            stageDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-md font-semibold text-indigo-500">${stageName}</h4>
                    <button class="btn btn-danger btn-sm py-1 px-2 text-xs remove-stage" data-id="${stageId}">Remove</button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <div><strong class="font-medium">Aim:</strong> <textarea data-id="${stageId}" data-field="aim" class="form-textarea text-xs p-1 mt-1 h-16 stage-input">${stageAim}</textarea></div>
                    <div><strong class="font-medium">Activity/Procedure:</strong> <textarea data-id="${stageId}" data-field="activity" class="form-textarea text-xs p-1 mt-1 h-16 stage-input">${stageActivity}</textarea></div>
                    <div><strong class="font-medium">Focus:</strong> <input type="text" value="${stageFocus}" data-id="${stageId}" data-field="focus" class="form-input text-xs p-1 mt-1 stage-input"></div>
                    <div><strong class="font-medium">Material:</strong> <input type="text" value="${stageMaterial}" data-id="${stageId}" data-field="material" class="form-input text-xs p-1 mt-1 stage-input"></div>
                    <div class="${stageName === 'Production' && parseInt(stageTiming) > 20 ? 'text-red-500 font-bold' : ''}">
                        <strong class="font-medium">Timing (min):</strong> 
                        <input type="number" value="${stageTiming}" data-id="${stageId}" data-field="timing" class="form-input text-xs p-1 mt-1 stage-input" min="0">
                        ${stageName === 'Production' && parseInt(stageTiming) > 20 ? '<span class="text-xs block">Max 20 min!</span>' : ''}
                    </div>
                </div>
            `;
            stagesContainer.appendChild(stageDiv);
        });
    }

    // Manipula a alteração de inputs dentro das etapas
    function handleStageInputChange(event) {
        if (event.target.classList.contains('stage-input')) {
            const stageId = event.target.dataset.id;
            const field = event.target.dataset.field;
            const value = event.target.value;
            const stageIndex = appState.stages.findIndex(s => s.id === stageId);
            if (stageIndex > -1) {
                appState.stages[stageIndex][field] = value;
                // Validação específica para o tempo da etapa de Production
                if (appState.stages[stageIndex].name === 'Production' && field === 'timing') {
                    if (parseInt(value) > 20) {
                        displayMessage('Production stage timing should not exceed 20 minutes.', 'error');
                    }
                    renderStages(); // Re-renderiza para mostrar aviso, se necessário
                }
            }
        }
    }
    stagesContainer.addEventListener('input', handleStageInputChange);

    // Manipula cliques no container de etapas (para remover etapa)
    stagesContainer.addEventListener('click', (event) => {
        if (event.target.classList.contains('remove-stage')) {
            const stageId = event.target.dataset.id;
            showConfirmationModal('Are you sure you want to remove this stage?', () => {
                appState.stages = appState.stages.filter(s => s.id !== stageId);
                renderStages();
            });
        }
    });

    // Lógica do Modal
    openAddStageModalBtn.onclick = () => {
        addStageModal.style.display = "block";
        // Reseta o formulário do modal
        stageTypeSelect.value = "Warm Up!";
        newStageNameInput.value = "Warm Up!"; // Preenche o nome padrão
        newStageNameInput.disabled = true;
        newStageAimInput.value = "";
        newStageActivityInput.value = "";
        newStageFocusInput.value = "";
        newStageMaterialInput.value = "";
        newStageTimingInput.value = getDefaultTiming("Warm Up!");
        productionTimeWarning.style.display = "none";
    }
    closeAddStageModalBtn.onclick = () => addStageModal.style.display = "none";
    window.onclick = (event) => { // Fecha o modal se clicar fora dele
        if (event.target == addStageModal) {
            addStageModal.style.display = "none";
        }
    }

    // Retorna o tempo padrão para cada tipo de etapa
    function getDefaultTiming(stageName) {
        switch(stageName) {
            case 'Warm Up!': return 7;
            case 'Practice': return 15;
            case 'Production': return 20; // Produção tem máximo de 20 min
            default: return 10; 
        }
    }

    // Atualiza o nome e tempo no modal ao mudar o tipo de etapa
    stageTypeSelect.addEventListener('change', () => {
        const selectedType = stageTypeSelect.value;
        if (selectedType === 'Custom') {
            newStageNameInput.disabled = false;
            newStageNameInput.value = "";
            newStageNameInput.focus();
            newStageTimingInput.value = getDefaultTiming(selectedType); // Ou um padrão genérico
        } else {
            newStageNameInput.disabled = true;
            newStageNameInput.value = selectedType; 
            newStageTimingInput.value = getDefaultTiming(selectedType);
        }
        checkProductionTimingModal();
    });
    newStageTimingInput.addEventListener('input', checkProductionTimingModal);
    newStageNameInput.addEventListener('input', checkProductionTimingModal); // Verifica se o nome customizado virou "Production"

    // Mostra aviso se o tempo de Production exceder 20 min no modal
    function checkProductionTimingModal() {
        const stageName = (stageTypeSelect.value === 'Custom') ? newStageNameInput.value.trim() : stageTypeSelect.value;
        if (stageName === 'Production' && parseInt(newStageTimingInput.value) > 20) {
            productionTimeWarning.style.display = 'block';
        } else {
            productionTimeWarning.style.display = 'none';
        }
    }

    // Confirma e adiciona nova etapa
    confirmAddStageBtn.onclick = () => {
        const type = stageTypeSelect.value;
        const name = (type === 'Custom') ? newStageNameInput.value.trim() : type;
        const aim = newStageAimInput.value.trim();
        const activity = newStageActivityInput.value.trim();
        const focus = newStageFocusInput.value.trim();
        const material = newStageMaterialInput.value.trim();
        const timing = newStageTimingInput.value.trim();
        // Validações
        if (!name) {
            displayMessage('Stage name is required for Custom type.', 'error'); return;
        }
        if (!timing || isNaN(parseInt(timing)) || parseInt(timing) < 0) {
            displayMessage('Valid timing (a positive number) is required.', 'error'); return;
        }
        // Confirmação para tempo de Production > 20 min
        if (name === 'Production' && parseInt(timing) > 20) {
            showConfirmationModal('Production stage timing exceeds 20 minutes. Do you want to proceed?', () => {
                addStageToStateAndRender(name, aim, activity, focus, material, timing);
            });
        } else {
            addStageToStateAndRender(name, aim, activity, focus, material, timing);
        }
    };

    // Adiciona a etapa ao estado e renderiza
    function addStageToStateAndRender(name, aim, activity, focus, material, timing) {
        appState.stages.push({ id: crypto.randomUUID(), name, aim, activity, focus, material, timing });
        renderStages();
        addStageModal.style.display = "none";
        displayMessage(`Stage "${name}" added.`);
    }
    
    // Converte uma imagem (incluindo SVG) para PNG Data URL usando um canvas
    function imageToPNGDataURL(imgElement, callback, errorCallback) {
        const attemptConversion = () => {
            try {
                const canvas = document.createElement('canvas');
                canvas.width = imgElement.naturalWidth || imgElement.width || 300; 
                canvas.height = imgElement.naturalHeight || imgElement.height || 150;
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    if (errorCallback) errorCallback(new Error("Canvas 2D context not available"));
                    return;
                }
                // Define um fundo branco para o canvas caso a imagem SVG tenha transparência
                // Isso evita que a transparência se torne preta no PNG.
                ctx.fillStyle = "#FFFFFF"; // Cor de fundo branca
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.drawImage(imgElement, 0, 0, canvas.width, canvas.height);
                const dataURL = canvas.toDataURL('image/png');
                callback(dataURL);
            } catch (e) {
                console.error("Canvas conversion error:", e);
                if (errorCallback) errorCallback(e);
            }
        };

        // Garante que a imagem (especialmente SVG de URL) esteja carregada
        if (imgElement.complete && (imgElement.naturalWidth !== 0 || imgElement.tagName !== 'IMG')) {
            attemptConversion();
        } else if (imgElement.tagName === 'IMG' && imgElement.src) {
            // Para tags <img>, clona para garantir que o 'load' seja disparado corretamente
            // Adicionado crossorigin="anonymous" na tag <img> no HTML
            const tempImage = new Image();
            tempImage.crossOrigin = imgElement.crossOrigin || "anonymous"; // Usa o crossOrigin do elemento original
            tempImage.onload = () => { // Usa arrow function para manter o 'this' de attemptConversion se necessário
                 // Passa tempImage para attemptConversion, pois é ela que está carregada
                const originalCanvas = document.createElement('canvas');
                originalCanvas.width = tempImage.naturalWidth || tempImage.width || 300;
                originalCanvas.height = tempImage.naturalHeight || tempImage.height || 150;
                const originalCtx = originalCanvas.getContext('2d');
                 if (!originalCtx) {
                    if (errorCallback) errorCallback(new Error("Canvas 2D context not available for temp image"));
                    return;
                }
                originalCtx.fillStyle = "#FFFFFF"; 
                originalCtx.fillRect(0, 0, originalCanvas.width, originalCanvas.height);
                originalCtx.drawImage(tempImage, 0, 0, originalCanvas.width, originalCanvas.height);
                const dataURL = originalCanvas.toDataURL('image/png');
                callback(dataURL);
            };
            tempImage.onerror = function() {
                console.error("Error loading image for canvas conversion:", imgElement.src);
                if (errorCallback) errorCallback(new Error("Image load error for canvas conversion"));
            };
            tempImage.src = imgElement.src;
        } else {
            console.warn("Image element might not be fully loaded or is not an IMG tag with src. Attempting direct conversion (might fail).");
            // Tenta a conversão direta como fallback, mas pode não funcionar para SVGs não carregados
             if (imgElement.width && imgElement.height) { // Se tiver dimensões, tenta
                attemptConversion();
            } else if (errorCallback) {
                errorCallback(new Error("Image not ready for conversion and dimensions unknown."));
            }
        }
    }


    // Gera o PDF
    async function generatePdf() {
        if (typeof jsPDF === 'undefined') { 
             displayMessage('PDF generation library not loaded. Cannot generate PDF.', 'error');
             return;
        }
        const doc = new jsPDF(); 
        if (typeof doc.autoTable !== 'function') {
            displayMessage('PDF table generation plugin (autoTable) not available. Tables may not be generated.', 'warning');
        }

        displayMessage('Generating PDF... Please wait.', 'success');
        saveState(); // Salva o estado atual antes de gerar

        // Cores da Passaporte Edu
        const passaporteBlue = [42, 47, 103]; // RGB para #2A2F67

        let yPos = 15; 
        const logoImgElement = document.getElementById('logoImage');
        let logoAdded = false;

        if (logoImgElement && logoImgElement.src && logoImgElement.src !== window.location.href ) {
            // Verifica se a imagem está visível (não deu erro no onerror do HTML)
            if (logoImgElement.style.display !== 'none') {
                try {
                    const dataUrl = await new Promise((resolve, reject) => {
                        imageToPNGDataURL(logoImgElement, data => resolve(data), err => reject(err));
                    });
                    
                    const logoWidth = 50; 
                    const img = new Image(); // Usa uma nova imagem para obter as dimensões do DataURL
                    img.onload = function() {
                        const aspectRatio = img.height / img.width;
                        const logoHeight = logoWidth * aspectRatio || 25; 
                        const pageWidth = doc.internal.pageSize.getWidth();
                        const logoX = (pageWidth - logoWidth) / 2;
                        try {
                            doc.addImage(dataUrl, 'PNG', logoX, yPos, logoWidth, logoHeight); 
                            yPos += logoHeight + 10;
                            logoAdded = true;
                        } catch (addImgError) {
                             console.error("jsPDF addImage error:", addImgError);
                             displayMessage('Failed to add logo image to PDF after conversion: ' + (addImgError.message || 'Unknown error'), 'error');
                        }
                    }
                    img.onerror = function() {
                        console.error("Error loading DataURL into temp image for dimension calculation.");
                        displayMessage('Failed to process logo dimensions for PDF.', 'error');
                    }
                    img.src = dataUrl; // Isso vai disparar o onload/onerror da img temporária

                } catch (e) {
                     console.error("Error processing logo for PDF:", e.message || e);
                     displayMessage('Failed to add logo to PDF: ' + (e.message || 'Unknown error'), 'error');
                }
            } else {
                 console.warn("Logo image element is hidden due to loading error, not adding to PDF.");
            }
        } else {
            console.warn("Logo image not found, not loaded, or src is invalid for PDF.");
            if (logoImgElement && logoImgElement.src && !logoImgElement.src.startsWith('http')) {
                // displayMessage('Logo src is not an HTTP/HTTPS URL, cannot fetch for PDF.', 'error');
            }
        }
        
        // Aguarda um pequeno tempo para a imagem ser processada, se necessário
        // Isso é um paliativo, o ideal é que o código acima com Promises e onload resolva o timing
        await new Promise(resolve => setTimeout(resolve, 500));


        // Título do Plano de Aula
        doc.setFontSize(18);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(passaporteBlue[0], passaporteBlue[1], passaporteBlue[2]);
        doc.text("LESSON PLAN", doc.internal.pageSize.getWidth() / 2, yPos, { align: 'center' });
        yPos += 10;
        doc.setTextColor(0, 0, 0); // Reseta a cor do texto para preto

        // Detalhes da Aula
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");

        const details = [
            { label: "Teacher", value: appState.teacher },
            { label: "Class Type", value: appState.classType },
            { label: "Lesson's Aim", value: appState.lessonAim },
            { label: "Objective", value: appState.objective },
            { label: "Date", value: appState.date },
            { label: "Class", value: appState.class },
            { label: "Level", value: appState.level },
            { label: "Number of Students", value: appState.numStudents },
            { label: "Possible Problems", value: appState.possibleProblems },
        ];
        
        details.forEach(detail => {
            if (detail.value) {
                if (yPos > doc.internal.pageSize.getHeight() - 25) { // Verifica quebra de página
                    doc.addPage(); yPos = 15;
                }
                doc.setFont("helvetica", "bold");
                doc.text(`${detail.label}:`, 15, yPos);
                doc.setFont("helvetica", "normal");
                const textWidth = doc.internal.pageSize.getWidth() - 30 - doc.getTextWidth(`${detail.label}: `) - 2;
                const splitValue = doc.splitTextToSize(detail.value, textWidth > 0 ? textWidth : 10); // Garante largura positiva
                doc.text(splitValue, 15 + doc.getTextWidth(`${detail.label}: `) + 2, yPos);
                yPos += (splitValue.length * 4) + 2; 
            }
        });
        yPos += 5;

        // Tabela de Etapas da Aula
        if (appState.stages.length > 0) {
             if (yPos > doc.internal.pageSize.getHeight() - 40) { // Verifica espaço para cabeçalho da tabela
                doc.addPage(); yPos = 15;
             }
            const head = [['STAGE', 'AIM', 'ACTIVITY/PROCEDURE', 'FOCUS', 'MATERIAL', 'TIMING (min)']];
            const body = appState.stages.map(s => [
                s.name || '', s.aim || '', s.activity || '', s.focus || '', s.material || '', String(s.timing || '')
            ]);
            if (typeof doc.autoTable === 'function') { 
                doc.autoTable({
                    startY: yPos,
                    head: head,
                    body: body,
                    theme: 'grid', 
                    headStyles: { 
                        fillColor: passaporteBlue, 
                        textColor: [255, 255, 255], 
                        fontStyle: 'bold' 
                    },
                    styles: { fontSize: 8, cellPadding: 1.5, overflow: 'linebreak' },
                    columnStyles: {
                        0: { cellWidth: 'auto' }, 1: { cellWidth: 'auto' }, 2: { cellWidth: 60 },   
                        3: { cellWidth: 'auto' }, 4: { cellWidth: 'auto' }, 5: { cellWidth: 'auto', halign: 'right' } 
                    },
                });
            } else {
                displayMessage("autoTable function not found. Table cannot be generated.", "error");
                doc.text("Table data could not be generated (autoTable plugin issue).", 15, yPos);
            }
        }

        // Salva o PDF
        const fileName = `lesson_plan_${appState.class || 'general'}_${appState.date || new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName.replace(/[^a-zA-Z0-9_.-]/g, '_')); // Sanitiza o nome do arquivo
        displayMessage('PDF generated and download started!');
    }

    // Modal de confirmação simples
    function showConfirmationModal(message, onConfirm) {
        if (window.confirm(message)) { 
            onConfirm();
        }
    }

    // Event Listeners dos botões
    document.getElementById('saveLessonPlan').addEventListener('click', saveState);
    document.getElementById('loadLessonPlan').addEventListener('click', loadState);
    document.getElementById('clearLessonPlan').addEventListener('click', clearState);
    document.getElementById('downloadPdf').addEventListener('click', generatePdf);

    // Define a data padrão no input de data
    function setDefaultDate() {
        if (!dateInput.value) {
            const today = new Date();
            const yyyy = today.getFullYear(); 
            const mm = String(today.getMonth() + 1).padStart(2, '0'); 
            const dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${yyyy}-${mm}-${dd}`;
        }
    }

    // Carregamento inicial
    setDefaultDate();
    loadState(); 
});
</script>
</body>
</html>
